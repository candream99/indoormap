<!DOCTYPE html>
<html lang="ko">
<head>
    <title>교보빌딩 1층 실내 지도 (수정 완료본 v9.1)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
        }
        #map {
            height: 100%;
        }
        #info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 100;
            max-width: 300px;
        }
        #info-panel h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
        }
        #info-panel p {
            margin: 5px 0;
            font-size: 14px;
            color: #666;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 100;
            display: none;
        }
        .button {
            background-color: #4285F4;
            border: none;
            color: white;
            padding: 8px 12px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="info-panel">
        <h3>교보빌딩 1층 실내지도</h3>
        <p>건물 영역을 클릭하면 실내지도가 표시됩니다.</p>
        <p>다시 클릭하면 지도로 돌아갑니다.</p>
        <button id="toggle-overlay" class="button">실내지도 토글</button>
    </div>
    
    <div id="loading">실내지도 로딩 중...</div>
    
    <div id="map"></div>

    <script>
        // =================================================================
        // 1. 전역 변수 및 상수 정의
        // =================================================================
        let customOverlay = null; 
        let isOverlayVisible = false;
        let map, buildingPolygon;

        // 지도 라벨 숨김 스타일
        const CLEAN_MAP_STYLE = [
            { featureType: "all", elementType: "labels", stylers: [{ visibility: "off" }] },
            { featureType: "all", elementType: "geometry", stylers: [{ saturation: -100 }] }
        ];

        // 8개 꼭짓점 Polygon 데이터 (클릭/호버 영역)
        const BUILDING_PERIMETER = [
            { lat: 37.571348, lng: 126.977638 },
            { lat: 37.571352, lng: 126.978030 },
            { lat: 37.571259, lng: 126.978032 },
            { lat: 37.571259, lng: 126.978156 },
            { lat: 37.570850, lng: 126.978161 },
            { lat: 37.570849, lng: 126.978041 },
            { lat: 37.570532, lng: 126.978044 },
            { lat: 37.570531, lng: 126.977657 }
        ];

        // 4개 꼭짓점 이미지 경계 데이터 (Image Overlay 배치용)
        const IMAGE_CORNERS = [
            { lat: 37.571348, lng: 126.977638 }, // NW
            { lat: 37.571353, lng: 126.978152 }, // NE
            { lat: 37.570542, lng: 126.978171 }, // SE
            { lat: 37.570527, lng: 126.977660 }  // SW
        ];
        
        // 4개 꼭짓점 기반 전체 경계
        const IMAGE_BOUNDS = {
            north: 37.571353, south: 37.570527,
            east: 126.978171, west: 126.977638
        };

        // =================================================================
        // 2. CustomImageOverlay 클래스 정의
        // =================================================================
        class CustomImageOverlay extends google.maps.OverlayView {
            constructor(map, imageUrl, cornerCoords) {
                super();
                this.map = map;
                this.imageUrl = imageUrl;
                this.cornerCoords = cornerCoords;
                this.div = null;
                this.img = null;
                this.isLoaded = false;
            }

            onAdd() {
                this.div = document.createElement('div');
                this.div.style.position = 'absolute';
                this.div.style.overflow = 'hidden';
                this.div.style.opacity = '0.9';
                this.div.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                this.div.style.borderRadius = '4px';

                this.img = document.createElement('img');
                this.img.src = this.imageUrl;
                this.img.style.position = 'absolute';
                this.img.style.pointerEvents = 'none';
                this.img.style.width = '100%';
                this.img.style.height = '100%';
                this.img.style.objectFit = 'cover';

                // 이미지 로드 이벤트 처리
                this.img.onload = () => {
                    this.isLoaded = true;
                    document.getElementById('loading').style.display = 'none';
                    this.draw();
                };

                this.img.onerror = () => {
                    document.getElementById('loading').style.display = 'none';
                    console.error('이미지 로드 실패: ' + this.imageUrl);
                    alert('실내지도 이미지를 로드할 수 없습니다.');
                };

                this.div.appendChild(this.img);
                const panes = this.getPanes();
                panes.overlayLayer.appendChild(this.div);
                
                this.div.style.visibility = 'hidden';
            }

            draw() {
                if (!this.div) return;
                const projection = this.getProjection();
                if (!projection) return;

                // 4개 꼭짓점의 위도/경도를 픽셀 좌표로 변환
                const pixels = this.cornerCoords.map(latLng => 
                    projection.fromLatLngToDivPixel(new google.maps.LatLng(latLng.lat, latLng.lng))
                );
                const p_nw = pixels[0], p_ne = pixels[1], p_se = pixels[2], p_sw = pixels[3];

                // 이미지 DIV의 Bounding Box 계산
                let minX = Math.min(p_nw.x, p_ne.x, p_se.x, p_sw.x);
                let minY = Math.min(p_nw.y, p_ne.y, p_se.y, p_sw.y);
                let maxX = Math.max(p_nw.x, p_ne.x, p_se.x, p_sw.x);
                let maxY = Math.max(p_nw.y, p_ne.y, p_se.y, p_sw.y);

                // DIV 위치와 크기 설정
                this.div.style.left = minX + 'px';
                this.div.style.top = minY + 'px';
                this.div.style.width = (maxX - minX) + 'px';
                this.div.style.height = (maxY - minY) + 'px';
            }

            onRemove() {
                if (this.div) {
                    this.div.parentNode.removeChild(this.div);
                    this.div = null;
                    this.img = null;
                }
            }

            hide() {
                if (this.div) {
                    this.div.style.visibility = 'hidden';
                }
            }
            
            show() {
                if (this.div) {
                    this.div.style.visibility = 'visible';
                }
            }
        }

        // =================================================================
        // 3. initMap 함수: API 로드 후 호출되는 메인 함수
        // =================================================================
        function initMap() {
            // 지도 중심 좌표 설정
            const kyoboCenter = {  
                lat: (IMAGE_BOUNDS.north + IMAGE_BOUNDS.south) / 2,  
                lng: (IMAGE_BOUNDS.east + IMAGE_BOUNDS.west) / 2  
            };

            // 지도 생성
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 18, 
                center: kyoboCenter, 
                mapTypeId: 'roadmap',
                gestureHandling: 'greedy'
            });

            // 스타일 지도 설정
            const cleanMapType = new google.maps.StyledMapType(CLEAN_MAP_STYLE, { name: "Clean Map" });
            map.mapTypes.set('clean_map', cleanMapType);

            // Polygon 생성 (8개 꼭짓점 외곽선)
            buildingPolygon = new google.maps.Polygon({
                paths: BUILDING_PERIMETER, 
                strokeColor: '#FF0000', 
                strokeOpacity: 1.0, 
                strokeWeight: 2,
                fillColor: '#FF0000', 
                fillOpacity: 0.0, 
                zIndex: 10, 
                map: map
            });

            // CustomImageOverlay 객체 생성
            customOverlay = new CustomImageOverlay(map, '1F_2.png', IMAGE_CORNERS);

            // 이벤트 리스너 설정
            
            // 마우스 오버/아웃 이벤트
            google.maps.event.addListener(buildingPolygon, 'mouseover', function() {
                if (!isOverlayVisible) { 
                    buildingPolygon.setOptions({ 
                        fillOpacity: 0.2,
                        strokeWeight: 3
                    }); 
                }
            });
            
            google.maps.event.addListener(buildingPolygon, 'mouseout', function() {
                if (!isOverlayVisible) { 
                    buildingPolygon.setOptions({ 
                        fillOpacity: 0.0,
                        strokeWeight: 2
                    }); 
                }
            });

            // 클릭 이벤트 (이미지 토글 및 스타일 변경)
            google.maps.event.addListener(buildingPolygon, 'click', function() {
                toggleOverlay();
            });

            // 토글 버튼 이벤트
            document.getElementById('toggle-overlay').addEventListener('click', function() {
                toggleOverlay();
            });
        }

        // =================================================================
        // 4. 오버레이 토글 함수
        // =================================================================
        function toggleOverlay() {
            if (!isOverlayVisible) {
                // 이미지 표시 및 지도 스타일 변경
                document.getElementById('loading').style.display = 'block';
                
                // 약간의 지연을 두어 로딩 표시가 보이도록 함
                setTimeout(function() {
                    customOverlay.setMap(map); 
                    customOverlay.show();
                    isOverlayVisible = true;
                    map.setMapTypeId('clean_map'); 
                    buildingPolygon.setOptions({ 
                        fillOpacity: 0.0, 
                        strokeWeight: 4,
                        strokeColor: '#4285F4'
                    });
                    
                    // 이미지가 이미 로드된 경우 로딩 숨김
                    if (customOverlay.isLoaded) {
                        document.getElementById('loading').style.display = 'none';
                    }
                }, 100);
            } else {
                // 이미지 숨김 및 지도 스타일 복원
                customOverlay.hide();
                customOverlay.setMap(null); 
                isOverlayVisible = false;
                map.setMapTypeId('roadmap');
                buildingPolygon.setOptions({ 
                    strokeWeight: 2, 
                    fillOpacity: 0.0,
                    strokeColor: '#FF0000'
                });
            }
        }

        // =================================================================
        // 5. 에러 처리
        // =================================================================
        function gm_authFailure() {
            alert('Google Maps 로드에 실패했습니다. API 키를 확인해주세요.');
        }
    </script>
    
    <!-- Google Maps API - 실제 배포 시 API 키를 환경 변수로 관리하세요 -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFx8u1rY7G06Ho4y-nYPLQ4RKy4zsW_og&callback=initMap">
    </script>
</body>
</html>
