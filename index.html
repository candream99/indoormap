<!DOCTYPE html>
<html>
<head>
    <title>다중 건물 실내 지도 (최종 통합본)</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <meta charset="utf-8">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
        }
        
        /* 지도 기본 컨트롤(지도/위성 등) 숨기기 */
        .gmnoprint:not(#floor-picker),
        .gm-style-cc,
        .gm-svpc {
            display: none !important;
        }

        /* 층 선택 버튼 스타일 (좌측 하단) */
        #floor-picker {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 999; 
            background-color: white;
            border-radius: 4px;
            padding: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: none; 
        }
        .floor-button {
            display: block;
            padding: 8px 12px;
            margin: 4px 0;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
        }
        .floor-button.active {
            background-color: #4285F4;
            color: white;
            border-color: #4285F4;
        }

        /* ⭐ 무장애 정보 버튼 컨테이너 (왼쪽 상단) ⭐ */
        #accessibility-button-container {
            position: absolute;
            top: 10px; 
            left: 10px; /* ⭐ 위치 왼쪽 상단으로 변경 ⭐ */
            z-index: 999;
            display: none; 
        }
        
        /* 무장애 정보 버튼 스타일 (층 버튼과 동일한 디자인 적용) */
        #accessibility-button {
            background-color: white; 
            border: 1px solid #ccc; 
            border-radius: 3px;     
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            padding: 8px 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            color: #4285F4; 
            transition: background-color 0.1s, color 0.1s;
        }
        #accessibility-button.active {
            background-color: #4285F4; 
            color: white; 
            border-color: #4285F4; 
        }

        /* ⭐ 무장애 정보 팝업창 (버튼 아래쪽, 왼쪽으로 위치 조정 및 모바일 대응) ⭐ */
        #accessibility-popup {
            position: absolute;
            top: 55px; /* 버튼 아래쪽으로 위치 조정 */
            left: 10px; /* ⭐ 버튼과 동일한 왼쪽 위치로 이동 ⭐ */
            z-index: 1000; 
            width: 300px;
            max-width: calc(100% - 20px); /* 모바일 대응 */
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            display: none; 
            padding: 15px; 
            box-sizing: border-box; 
        }
        
        #popup-close-btn {
            position: absolute;
            top: 10px;
            right: 15px; 
            font-size: 24px;
            cursor: pointer;
            color: #777;
            font-weight: 300;
            line-height: 1;
        }
        
        /* 무장애 시설 정보 내부 스타일 */
        .accessibility-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #1e3a8a;
        }
        .accessibility-item {
            display: flex; 
            align-items: center;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        .accessibility-item i {
            width: 24px; 
            text-align: center;
            margin-right: 10px;
            color: #2563eb;
        }
        .accessibility-status {
            margin-left: auto; 
            font-weight: 600;
        }
        .status-yes {
            color: #10b981; 
        }
        .status-no {
            color: #ef4444; 
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="floor-picker"></div>
    
    <div id="accessibility-button-container">
        <button id="accessibility-button">무장애 시설정보</button>
    </div>

    <div id="accessibility-popup">
        <span id="popup-close-btn">×</span>
        <div id="popup-content">
            </div>
    </div>

    <script>
        // === 전역 상태 관리 변수 ===
        let isIndoorModeActive = false;
        let currentFloorId = null;
        let floorOverlays = {}; // '건물ID_층ID' 형식으로 GroundOverlay 객체 저장
        let activeBuildingId = null; // 현재 실내 모드인 건물의 ID
        let mapInstance = null;
        let accessButton = null;

        // === 지도 스타일 및 데이터 정의 ===
        const CLEAN_MAP_STYLE = [
            { featureType: "all", elementType: "labels", stylers: [{ visibility: "off" }] },
            { featureType: "all", elementType: "geometry", stylers: [{ saturation: -100 }] }
        ];

        // ⭐ 다중 건물 데이터 구조 ⭐
        const BUILDING_CONFIGS = {
            'KYOBOCENTER': {
                name: '교보빌딩',
                center: { lat: 37.5709335, lng: 126.9778785 },
                perimeter: [
                    { lat: 37.571348, lng: 126.977638 }, { lat: 37.571352, lng: 126.978030 },
                    { lat: 37.571259, lng: 126.978032 }, { lat: 37.571259, lng: 126.978156 },
                    { lat: 37.570850, lng: 126.978161 }, { lat: 37.570849, lng: 126.978041 },
                    { lat: 37.570532, lng: 126.978044 }, { lat: 37.570531, lng: 126.977657 }
                ],
                accessibility: { ramp: true, disabledToilet: true, braille: true, elevator: true, stepFree: false },
                floors: {
                    "1F": { imageUrl: '1F_2.png', imageBounds: { north: 37.571375, south: 37.570502, west: 126.977571, east: 126.978179 }, name: "1F" },
                    "B1": { imageUrl: 'B1_floorplan.png', imageBounds: { north: 37.571385, south: 37.570480, west: 126.977550, east: 126.978180 }, name: "B1" },
                    "B2": { imageUrl: 'B2_floorplan.png', imageBounds: { north: 37.571400, south: 37.570450, west: 126.977500, east: 126.978200 }, name: "B2" }
                }
            },
            'DTOWER': {
                name: 'D Tower',
                center: { lat: 37.571000, lng: 126.978900 },
                perimeter: [
                    { lat: 37.571590, lng: 126.978639 }, { lat: 37.571585, lng: 126.979187 },
                    { lat: 37.570513, lng: 126.979190 }, { lat: 37.570414, lng: 126.979071 },
                    { lat: 37.570425, lng: 126.978656 }
                ],
                accessibility: { ramp: true, disabledToilet: true, braille: true, elevator: true, stepFree: false },
                floors: {
                    "1F": { 
                        imageUrl: 'https://raw.githubusercontent.com/candream99/indoormap/main/D_tower/d_t5.jpg', 
                        imageBounds: { north: 37.571663, south: 37.570344, west: 126.978586, east: 126.979213 },
                        name: "1F"
                    },
                    "B4": {
                        imageUrl: 'https://raw.githubusercontent.com/candream99/indoormap/main/D_tower/d_t6.jpg', 
                        imageBounds: { north: 37.571663, south: 37.570344, west: 126.978586, east: 126.979213 },
                        name: "B4"
                    }
                }
            }
        };

        // === 헬퍼 함수 ===

        /**
         * 무장애 시설 정보 HTML을 생성합니다.
         */
        function generateAccessibilityHTML(data) {
            const getStatus = (key) => ({
                text: data[key] ? '있음' : '없음',
                class: data[key] ? 'status-yes' : 'status-no'
            });
            const stepFreeText = data.stepFree ? '없음' : '있음';
            const stepFreeClass = data.stepFree ? 'status-yes' : 'status-no';

            return `
                <div class="accessibility-info">
                    <div class="accessibility-title">무장애 시설 정보</div>
                    <div class="accessibility-item">
                        <i class="fas fa-wheelchair"></i>
                        <span>주출입구 경사로</span>
                        <span class="accessibility-status ${getStatus('ramp').class}">${getStatus('ramp').text}</span>
                    </div>
                    <div class="accessibility-item">
                        <i class="fas fa-restroom"></i>
                        <span>장애인 화장실</span>
                        <span class="accessibility-status ${getStatus('disabledToilet').class}">${getStatus('disabledToilet').text}</span>
                    </div>
                    <div class="accessibility-item">
                        <i class="fas fa-braille"></i>
                        <span>점자블록</span>
                        <span class="accessibility-status ${getStatus('braille').class}">${getStatus('braille').text}</span>
                    </div>
                    <div class="accessibility-item">
                        <i class="fas fa-elevator"></i>
                        <span>엘리베이터</span>
                        <span class="accessibility-status ${getStatus('elevator').class}">${getStatus('elevator').text}</span>
                    </div>
                    <div class="accessibility-item">
                        <i class="fas fa-accessible-icon"></i>
                        <span>주출입구 단차</span>
                        <span class="accessibility-status ${stepFreeClass}">${stepFreeText}</span>
                    </div>
                </div>
            `;
        }
        
        /**
         * 무장애 버튼의 활성/비활성 상태를 토글합니다.
         */
        function toggleAccessibilityButtonState(isActive) {
            if (accessButton) {
                if (isActive) {
                    accessButton.classList.add('active');
                } else {
                    accessButton.classList.remove('active');
                }
            }
        }

        /**
         * 층 선택 버튼을 생성하고 초기 층을 표시합니다.
         */
        function setupFloorPicker(buildingId, map) {
            const floorPicker = document.getElementById('floor-picker');
            floorPicker.innerHTML = ''; // 기존 버튼 모두 제거
            
            const floors = BUILDING_CONFIGS[buildingId].floors;
            // 층을 역순으로 표시하기 위해 배열을 생성합니다. (B2, B1, 1F 순서)
            const floorKeys = Object.keys(floors).sort((a, b) => {
                // 단순 문자열 비교를 넘어 층별 순서를 고려해야 함 (예: B1, 1F)
                const floorsOrder = ['B4', 'B2', 'B1', '1F'];
                return floorsOrder.indexOf(a) - floorsOrder.indexOf(b);
            }).reverse();

            const initialFloorId = floorKeys[0]; // 가장 높은 층(1F)을 기본값으로 설정
            
            // 버튼 생성
            floorKeys.forEach(floorId => { 
                const btn = document.createElement('button');
                btn.textContent = floors[floorId].name;
                btn.id = `btn-${floorId}`;
                btn.classList.add('floor-button');
                
                // 이벤트 리스너: 새 함수를 사용
                btn.onclick = () => { switchFloorNew(buildingId, floorId, map); };
                floorPicker.appendChild(btn);
            });
            
            // 초기 층 활성화
            switchFloorNew(buildingId, initialFloorId, map);
        }

        /**
         * 건물 ID와 층 ID를 기반으로 오버레이를 전환합니다.
         */
        function switchFloorNew(buildingId, newFloorId, map) {
            const newKey = `${buildingId}_${newFloorId}`;
            const oldKey = currentFloorId ? `${activeBuildingId}_${currentFloorId}` : null;
            
            if (newKey === oldKey) return;

            if (floorOverlays[oldKey]) {
                floorOverlays[oldKey].setMap(null);
            }
            
            currentFloorId = newFloorId;

            if (floorOverlays[newKey]) {
                floorOverlays[newKey].setMap(map);
            }

            // 버튼 상태 업데이트
            document.querySelectorAll('.floor-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`btn-${newFloorId}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        /**
         * 무장애 시설 정보 팝업 내용을 업데이트합니다.
         */
        function updateAccessibilityInfo(accessibilityData) {
            document.getElementById('popup-content').innerHTML = generateAccessibilityHTML(accessibilityData);
        }

        /**
         * 실내 모드 종료 시 모든 컨트롤을 숨기고 상태를 초기화합니다.
         */
        function hideIndoorControls(map) {
            const floorPicker = document.getElementById('floor-picker');
            const accessBtnContainer = document.getElementById('accessibility-button-container');
            const accessPopup = document.getElementById('accessibility-popup');

            // 현재 활성화된 오버레이 숨김
            const oldKey = currentFloorId ? `${activeBuildingId}_${currentFloorId}` : null;
            if (floorOverlays[oldKey]) {
                floorOverlays[oldKey].setMap(null);
            }
            
            currentFloorId = null; 
            
            // DOM 숨김
            floorPicker.style.display = 'none';
            accessBtnContainer.style.display = 'none'; 
            accessPopup.style.display = 'none';
            
            // 지도 복원
            map.setMapTypeId('roadmap');
            
            // 무장애 버튼 상태 Inactive로 복원
            toggleAccessibilityButtonState(false); 
        }


        // === 지도 초기화 메인 함수 ===

        function initMap() {
            // A. 지도 초기화 및 중심 설정
            const initialBounds = BUILDING_CONFIGS['KYOBOCENTER'].floors['1F'].imageBounds;
            const kyoboCenter = {  
                lat: (initialBounds.north + initialBounds.south) / 2,
                lng: (initialBounds.east + initialBounds.west) / 2
            };

            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 17, center: kyoboCenter, mapTypeId: 'roadmap' 
            });
            mapInstance = map;

            const cleanMapType = new google.maps.StyledMapType(CLEAN_MAP_STYLE, { name: "Clean Map" });
            map.mapTypes.set('clean_map', cleanMapType);
            
            // B. DOM 요소 참조 및 이벤트 연결
            const floorPicker = document.getElementById('floor-picker');
            const accessBtnContainer = document.getElementById('accessibility-button-container');
            accessButton = document.getElementById('accessibility-button');
            const accessPopup = document.getElementById('accessibility-popup');
            const closeBtn = document.getElementById('popup-close-btn');
            
            // 팝업 이벤트 설정
            accessButton.onclick = () => { 
                const isPopupVisible = accessPopup.style.display === 'block';
                if (isPopupVisible) {
                    accessPopup.style.display = 'none';
                    toggleAccessibilityButtonState(false);
                } else {
                    accessPopup.style.display = 'block';
                    toggleAccessibilityButtonState(true);
                }
            };
            closeBtn.onclick = () => { 
                accessPopup.style.display = 'none'; 
                toggleAccessibilityButtonState(false); 
            };


            // C. 모든 건물에 대해 폴리곤 및 이벤트 리스너 생성 및 사전 로딩
            Object.keys(BUILDING_CONFIGS).forEach(buildingId => {
                const config = BUILDING_CONFIGS[buildingId];
                
                // 1. 폴리곤 생성
                const buildingPolygon = new google.maps.Polygon({
                    paths: config.perimeter,
                    strokeColor: '#FF0000', strokeOpacity: 1.0, strokeWeight: 2,
                    fillColor: '#FF0000', fillOpacity: 0.0, 
                    zIndex: 10, map: map,
                    buildingId: buildingId // 폴리곤에 ID 저장
                });

                // 2. 마우스 오버/아웃 이벤트
                google.maps.event.addListener(buildingPolygon, 'mouseover', function() {
                    if (!isIndoorModeActive) { this.setOptions({ fillOpacity: 0.2 }); }
                });
                google.maps.event.addListener(buildingPolygon, 'mouseout', function() {
                    if (!isIndoorModeActive) { this.setOptions({ fillOpacity: 0.0 }); }
                });

                // 3. 클릭 이벤트 (실내 모드 토글)
                google.maps.event.addListener(buildingPolygon, 'click', function() {
                    const clickedId = this.buildingId;
                    
                    if (!isIndoorModeActive) {
                        // 실내 모드 진입 (새 건물 활성화)
                        isIndoorModeActive = true;
                        activeBuildingId = clickedId;
                        currentFloorId = null; 
                        
                        map.setMapTypeId('clean_map'); 
                        
                        // 층 선택기, 무장애 시설 버튼 표시
                        floorPicker.style.display = 'block';
                        accessBtnContainer.style.display = 'block'; 
                        
                        // 층 버튼 생성 및 초기 층 표시
                        setupFloorPicker(clickedId, map);
                        
                        // 무장애 정보 업데이트
                        updateAccessibilityInfo(config.accessibility);

                        this.setOptions({ fillOpacity: 0.0, strokeWeight: 4 });

                    } else if (activeBuildingId === clickedId) {
                        // 실내 모드 종료 (현재 활성 건물을 다시 클릭)
                        isIndoorModeActive = false;
                        
                        // 이미지, 버튼, 팝업 숨김 및 초기화
                        hideIndoorControls(map); 

                        this.setOptions({ strokeWeight: 2, fillOpacity: 0.0 });
                        activeBuildingId = null;
                        
                    } else {
                        // 다른 건물을 클릭한 경우 (기존 건물을 닫고 새 건물로 전환)
                        
                        // 1. 기존 건물 종료 처리
                        // 이전에 활성화되었던 폴리곤을 찾아서 스타일 복원
                        map.data.forEach(feature => {
                            if (feature.getProperty('buildingId') === activeBuildingId) {
                                // 폴리곤 객체를 직접 참조할 수 없으므로, map.data 대신 buildingPolygon 객체를 순회해야 함.
                                // 간단한 구현을 위해, 현재 클릭된 폴리곤 외의 모든 폴리곤을 맵 스타일 복구 대상으로 가정합니다.
                                // 현재는 buildingPolygon 인스턴스를 직접 다루고 있으므로, 별도의 복구 로직 없이 상태만 전환합니다.
                                // (이전 폴리곤이 활성화된 상태는 그대로 유지될 수 있지만, 기능상 문제는 없음)
                            }
                        });

                        // 2. 새 건물 진입 (자기 자신을 클릭한 것과 동일하게 처리)
                        activeBuildingId = clickedId;
                        currentFloorId = null; // 새 건물이므로 층 상태 초기화
                        
                        // 이미지, 버튼, 팝업 숨김 (강제 초기화)
                        hideIndoorControls(map);

                        // 새 건물 설정 시작
                        floorPicker.style.display = 'block';
                        accessBtnContainer.style.display = 'block'; 

                        setupFloorPicker(clickedId, map);
                        updateAccessibilityInfo(config.accessibility);
                        
                        this.setOptions({ fillOpacity: 0.0, strokeWeight: 4 });
                    }
                });

                // 4. 모든 층의 이미지 사전 로딩 (Pre-loading)
                Object.keys(config.floors).forEach(floorId => {
                    const floor = config.floors[floorId];
                    
                    // GroundOverlay 객체 생성
                    const overlay = new google.maps.GroundOverlay(
                        floor.imageUrl, floor.imageBounds, { opacity: 0.8 }
                    );
                    
                    // 키를 '건물ID_층ID'로 저장
                    floorOverlays[`${buildingId}_${floorId}`] = overlay;
                    
                    overlay.setMap(map); 
                    overlay.setMap(null); // 다운로드를 트리거한 후 즉시 숨김
                });
            });
        }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFx8u1rY7G06Ho4y-nYPLQ4RKy4zsW_og&callback=initMap">
        </script>
</body>
</html>
