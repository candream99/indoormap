<!DOCTYPE html>
<html>
<head>
    <title>교보빌딩 1층 실내 지도 (최종 수정본 v11.1)</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // =================================================================
        // 1. 전역 변수 및 상수 정의
        // =================================================================
        let customOverlay = null; 
        let isOverlayVisible = false;

        const CLEAN_MAP_STYLE = [
            { featureType: "all", elementType: "labels", stylers: [{ visibility: "off" }] },
            { featureType: "all", elementType: "geometry", stylers: [{ saturation: -100 }] }
        ];

        const BUILDING_PERIMETER = [
            { lat: 37.571348, lng: 126.977638 },
            { lat: 37.571352, lng: 126.978030 },
            { lat: 37.571259, lng: 126.978032 },
            { lat: 37.571259, lng: 126.978156 },
            { lat: 37.570850, lng: 126.978161 },
            { lat: 37.570849, lng: 126.978041 },
            { lat: 37.570532, lng: 126.978044 },
            { lat: 37.570531, lng: 126.977657 }
        ];

        const IMAGE_CORNERS = [
            { lat: 37.571348, lng: 126.977638 }, 
            { lat: 37.571353, lng: 126.978152 },
            { lat: 37.570542, lng: 126.978171 },
            { lat: 37.570527, lng: 126.977660 }
        ];

        const IMAGE_BOUNDS = {
            north: 37.571353, south: 37.570527,
            east: 126.978171, west: 126.977638
        };


        // =================================================================
        // 2. initMap 실행
        // =================================================================
        function initMap() {

            // =======================
            // Custom Overlay 클래스
            // =======================
            class CustomImageOverlay extends google.maps.OverlayView {
                constructor(map, imageUrl, cornerCoords) {
                    super();
                    this.map = map;
                    this.imageUrl = imageUrl;
                    this.cornerCoords = cornerCoords;
                    this.div = null;

                    // ⭐ 생성 시점에 map을 바로 setMap 함
                    this.setMap(map);
                }

                onAdd() {
                    this.div = document.createElement('div');
                    this.div.style.position = 'absolute';
                    this.div.style.overflow = 'hidden';
                    this.div.style.opacity = '0.85';
                    this.div.style.visibility = 'visible';   // ⭐ hidden 제거

                    const img = document.createElement('img');
                    img.src = this.imageUrl;
                    img.style.position = 'absolute';
                    img.style.pointerEvents = 'none';

                    img.onload = () => console.log("이미지 로드 성공");
                    img.onerror = () => console.error("이미지 로드 실패:", this.imageUrl);

                    this.div.appendChild(img);
                    this.getPanes().overlayLayer.appendChild(this.div);
                }

                draw() {
                    if (!this.div) return;

                    const projection = this.getProjection();
                    if (!projection) return;

                    const imgEl = this.div.querySelector('img');
                    if (!imgEl) return;

                    const pixels = this.cornerCoords.map(c =>
                        projection.fromLatLngToDivPixel(new google.maps.LatLng(c.lat, c.lng))
                    );

                    const p_nw = pixels[0], p_ne = pixels[1], p_se = pixels[2], p_sw = pixels[3];

                    const minX = Math.min(p_nw.x, p_ne.x, p_se.x, p_sw.x);
                    const minY = Math.min(p_nw.y, p_ne.y, p_se.y, p_sw.y);
                    const maxX = Math.max(p_nw.x, p_ne.x, p_se.x, p_sw.x);
                    const maxY = Math.max(p_nw.y, p_ne.y, p_se.y, p_sw.y);

                    this.div.style.left = minX + 'px';
                    this.div.style.top = minY + 'px';
                    this.div.style.width = (maxX - minX) + 'px';
                    this.div.style.height = (maxY - minY) + 'px';

                    imgEl.style.width = '100%';
                    imgEl.style.height = '100%';

                    const offsetX = p_nw.x - minX;
                    const offsetY = p_nw.y - minY;
                    imgEl.style.transform = `translate3d(${offsetX}px, ${offsetY}px, 0)`;
                }

                onRemove() {
                    if (this.div) {
                        this.div.parentNode.removeChild(this.div);
                        this.div = null;
                    }
                }

                show() {
                    if (this.div) this.div.style.visibility = 'visible';
                }
                hide() {
                    if (this.div) this.div.style.visibility = 'hidden';
                }
            }


            // =======================
            // 지도 초기화
            // =======================
            const kyoboCenter = {
                lat: (IMAGE_BOUNDS.north + IMAGE_BOUNDS.south) / 2,
                lng: (IMAGE_BOUNDS.east + IMAGE_BOUNDS.west) / 2
            };

            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 18,
                center: kyoboCenter,
                mapTypeId: 'roadmap'
            });

            const cleanMapType = new google.maps.StyledMapType(CLEAN_MAP_STYLE, { name: "Clean Map" });
            map.mapTypes.set('clean_map', cleanMapType);

            const buildingPolygon = new google.maps.Polygon({
                paths: BUILDING_PERIMETER,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.0,
                zIndex: 10,
                map: map
            });

            // ⭐ map을 넣어서 Overlay 생성 (가장 중요!!)
            customOverlay = new CustomImageOverlay(
                map,
                '1F_2.png',
                IMAGE_CORNERS
            );


            // =======================
            // 이벤트
            // =======================
            google.maps.event.addListener(buildingPolygon, 'mouseover', function () {
                if (!isOverlayVisible) buildingPolygon.setOptions({ fillOpacity: 0.2 });
            });

            google.maps.event.addListener(buildingPolygon, 'mouseout', function () {
                if (!isOverlayVisible) buildingPolygon.setOptions({ fillOpacity: 0.0 });
            });

            google.maps.event.addListener(buildingPolygon, 'click', function () {
                if (!isOverlayVisible) {
                    customOverlay.show();
                    isOverlayVisible = true;
                    map.setMapTypeId('clean_map');
                    buildingPolygon.setOptions({ fillOpacity: 0.0, strokeWeight: 4 });
                } else {
                    customOverlay.hide();
                    isOverlayVisible = false;
                    map.setMapTypeId('roadmap');
                    buildingPolygon.setOptions({ strokeWeight: 2, fillOpacity: 0.0 });
                }
            });
        }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFx8u1rY7G06Ho4y-nYPLQ4RKy4zsW_og&callback=initMap">
    </script>
</body>
</html>
